<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Daily Gratitude ‚Äî JayTeeSF</title>
  <meta name="description" content="A simple daily gratitude journal that stores on YOUR own device and lets you review your history." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Julius+Sans+One&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./index.css" />
  <meta name="color-scheme" content="light dark">
  <style>
    .journal { padding: 2rem 0 3rem; }
    .journal-grid { display: grid; grid-template-columns: 1.1fr .9fr; gap: 1rem; }
    @media (max-width: 900px) { .journal-grid { grid-template-columns: 1fr; } }
    .journal-card { background: var(--surface-0); border: 1px solid var(--border); border-radius: 14px; box-shadow: var(--shadow); }
    .journal-card header { display:flex; align-items:center; justify-content:space-between; padding: .9rem 1rem; border-bottom:1px solid var(--border); }
    .journal-card .body { padding: 1rem; }
    .journal-card .foot { display:flex; gap:.6rem; justify-content:flex-end; padding: .9rem 1rem; border-top:1px solid var(--border); }
    .field { display:grid; gap:.35rem; margin-bottom:.8rem; }
    .field label { font-weight: 700; }
    .field small { color: var(--muted); }
    .field input[type="text"],
    .field input[type="email"],
    .field input[type="date"],
    .field textarea { width:100%; padding:.7rem .8rem; border-radius:10px; border:1px solid var(--border); background:var(--surface-1); color:var(--text); }
    .field textarea { min-height: 84px; resize: vertical; }
    .toolbar { display:flex; gap:.6rem; align-items:center; flex-wrap:wrap; }
    .toolbar input[type="search"] { padding:.55rem .7rem; border-radius:999px; border:1px solid var(--border); background:var(--surface-1); color:var(--text); }
    .history-list { display:grid; gap:.6rem; }
    .history-item { border:1px solid var(--border); border-radius:12px; padding:.8rem; background:var(--surface-0); }
    .history-item h4 { margin:.1rem 0 .3rem; display:flex; gap:.5rem; align-items:center; justify-content:space-between; }
    .pill { display:inline-block; font-size:.82rem; padding:.2rem .5rem; border:1px solid var(--border); border-radius:999px; color:var(--muted); background:var(--surface-1); }
    .empty { color: var(--muted); text-align:center; padding: 1.2rem; }
    .tiny { font-size:.9rem; color: var(--muted); }
    .inline-form-help { font-size:.92rem; color:var(--muted); margin-top:.5rem; }
    .muted-sm { font-size:.9rem; color:var(--muted); }
    .suggest { display:flex; gap:.5rem; align-items:center; flex-wrap:wrap; margin-top:.4rem; }
    .suggest-list { margin-top:.6rem; display:grid; gap:.45rem; }
    .suggest-item { display:flex; align-items:center; justify-content:space-between; gap:.6rem; padding:.5rem .6rem; border:1px solid var(--border); border-radius:10px; background:var(--surface-1); }
    .verse-chip { display:inline-block; padding:.1rem .45rem; border-radius:8px; border:1px solid var(--border); background:var(--surface-1); cursor:pointer; }
    .icon-btn { background: transparent; border: 1px solid var(--border); border-radius: 10px; padding: .45rem .6rem; cursor: pointer; }
  </style>
</head>
<body id="page-top">
  <a href="#main" class="skip-link">Skip to content</a>

  <header class="site-header" role="banner">
    <div class="container nav" id="site-nav" aria-expanded="false">
      <a class="brand" href="./index.html" aria-label="JayTeeSF home">
        <img src="./logo-jayteesf.svg" alt="JayTeeSF logo" class="logo" />
        <strong class="brand-name">
          <span>J</span><span class="sc">ay</span><span>T</span><span class="sc">ee</span><span class="brand-sf">SF</span>
          <span class="brand-tagline">Software Consulting for Startups</span>
        </strong>
      </a>
      <button class="menu-toggle" aria-controls="primary-navigation" aria-expanded="false" title="Menu" id="menuBtn">
        <svg width="22" height="18" viewBox="0 0 22 18" fill="none" aria-hidden="true">
          <rect x="0" y="1" width="22" height="2" rx="1"></rect>
          <rect x="0" y="8" width="22" height="2" rx="1"></rect>
          <rect x="0" y="15" width="22" height="2" rx="1"></rect>
        </svg>
      </button>
      <nav id="primary-navigation" class="nav-list">
        <a href="./index.html#how-works">About</a>
        <a href="#journal">Journal</a>
        <button class="theme-toggle" id="themeToggle" type="button" aria-label="Toggle theme">‚òÄÔ∏é/‚òæ</button>
      </nav>
    </div>
  </header>

  <main id="main">
    <section class="hero" role="region" aria-label="Intro">
      <div class="container hero-inner">
        <div>
          <h1 class="headline">Daily <span class="accent">Gratitude</span> Journal</h1>
          <p class="lead">Capture today's three gratitudes and one thing you're looking forward to. Everything is stored <strong>locally on YOUR own device</strong>; export/import JSON and CSV anytime.</p>
          <div class="hero-cta">
            <a href="#journal" class="btn outline">Start journaling</a>
          </div>
        </div>
        <aside class="hero-card" aria-label="Tips">
          <div class="list">
            <div class="check">Unlimited entries (any day)</div>
            <div class="check">Device-local timeline</div>
            <div class="check">Optional email tag for you</div>
          </div>
        </aside>
      </div>
    </section>

    <section id="journal" class="container journal">
      <h2 class="section-title">Today's entry</h2>
      <div class="journal-grid">
        <!-- Composer -->
        <article class="journal-card" aria-label="Entry composer">
          <header>
            <strong>Compose</strong>
            <span class="pill" id="today"></span>
          </header>
          <div class="body">
            <div class="field">
              <label for="email">Your email (optional)</label>
              <input id="email" type="email" placeholder="you@example.com" autocomplete="email" />
              <small class="muted-sm">Stored only on YOUR own device; used for filtering your timeline.</small>
            </div>

            <div class="field">
              <label for="date">Date</label>
              <input id="date" type="date" />
            </div>

            <div class="field">
              <label for="g1">Gratitude #1</label>
              <textarea id="g1" placeholder="First thing you're grateful for..."></textarea>
            </div>
            <div class="field">
              <label for="g2">Gratitude #2</label>
              <textarea id="g2" placeholder="Second thing you're grateful for..."></textarea>
            </div>
            <div class="field">
              <label for="g3">Gratitude #3</label>
              <textarea id="g3" placeholder="Third thing you're grateful for..."></textarea>
            </div>

            <div class="field">
              <label for="look">Looking forward to</label>
              <textarea id="look" placeholder="One thing you're looking forward to today..."></textarea>
            </div>

            <div class="field">
              <label for="scripture_ref">Meditation scripture (optional)</label>
              <input id="scripture_ref" type="text" placeholder="e.g., James 1:17" list="refSuggestions" />
              <datalist id="refSuggestions"></datalist>
              <div class="inline-form-help">Topic suggestions & BLB search</div>
              <div class="suggest">
                <!-- keep ONE topic input; remove "Suggest 5" and extra Criteria box -->
                <input id="topic" type="text" value="gratitude" aria-label="Topic" />
                <form id="blbForm" action="https://www.blueletterbible.org/search/preSearch.cfm" method="get" target="_blank" style="display:inline-flex; gap:.5rem; align-items:center;">
                  <input type="hidden" name="Criteria" id="blbCriteria" />
                  <input type="hidden" name="sort" value="Relevance" />
                  <select name="t" id="blbTranslation" title="Translation">
                    <option value="ESV" selected>ESV</option>
                    <option value="KJV">KJV</option>
                    <option value="NKJV">NKJV</option>
                    <option value="NASB95">NASB95</option>
                    <option value="NIV">NIV</option>
                    <option value="CSB">CSB</option>
                    <option value="NLT">NLT</option>
                    <option value="RSV">RSV</option>
                  </select>
                  <button class="btn outline" type="submit">Open in BLB</button>
                </form>
              </div>

              <!-- suggestions update LIVE as topic changes -->
              <div id="suggestions" class="suggest-list"></div>
            </div>
          </div>
          <div class="foot">
            <button class="btn outline" id="clearBtn" type="button">Clear</button>
            <button class="btn" id="saveBtn" type="button">Save</button>
            <button class="btn" id="saveNewBtn" type="button">Save & New</button>
          </div>
        </article>

        <!-- History -->
        <aside class="journal-card" aria-label="Your history">
          <header>
            <strong>Your history (device)</strong>
            <div class="toolbar">
              <input id="q" type="search" placeholder="Search text‚Ä¶" />
              <input id="qEmail" type="search" placeholder="Filter by email‚Ä¶" />
              <input id="qFrom" type="date" />
              <input id="qTo" type="date" />
              <button class="icon-btn" id="filterBtn" title="Apply filters">üîç</button>
              <button class="icon-btn" id="resetBtn" title="Reset filters">‚Ü∫</button>
              <button class="icon-btn" id="exportBtn" title="Export JSON">‚á©</button>
              <label class="icon-btn" title="Import JSON" style="cursor:pointer">
                ‚áß<input id="importInput" type="file" accept="application/json" hidden />
              </label>
              <button class="icon-btn" id="exportCsvBtn" title="Export CSV">CSV</button>
            </div>
          </header>
          <div class="body">
            <div id="history" class="history-list"></div>
            <div id="emptyHistory" class="empty" hidden>No entries yet. Save an entry to see it here.</div>
          </div>
          <div class="foot">
            <button class="btn outline" id="purgeBtn" type="button">Delete all (device)</button>
          </div>
        </aside>
      </div>
    </section>
  </main>

  <footer role="contentinfo">
    <div class="container footer">
      <div>¬© 2018‚Äì2026 JayTeeSF. All rights reserved.</div>
      <nav class="footer-links">
        <a href="./index.html#how-works">About</a>
        <a href="#journal">Journal</a>
      </nav>
    </div>
  </footer>

  <script>
    // ===== Theme + nav (unchanged) =====
    const root = document.documentElement;
    const themeKey = "jayteesf-theme";
    function setTheme(mode){
      if(mode==="dark"){ root.setAttribute("data-theme","dark"); localStorage.setItem(themeKey,"dark"); }
      else if(mode==="light"){ root.setAttribute("data-theme","light"); localStorage.setItem(themeKey,"light"); }
      else { root.removeAttribute("data-theme"); localStorage.removeItem(themeKey); }
    }
    const stored = localStorage.getItem(themeKey); if (stored) setTheme(stored);
    document.getElementById("themeToggle").addEventListener("click", () => {
      const current = root.getAttribute("data-theme") || (matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light");
      setTheme(current === "dark" ? "light" : "dark");
    });
    const nav = document.getElementById("site-nav");
    const menuBtn = document.getElementById("menuBtn");
    function updateAnchorOffset() {
      const header = document.querySelector(".site-header");
      const h = header ? Math.ceil(header.getBoundingClientRect().height) : 0;
      document.documentElement.style.setProperty("--anchor-offset", `${h + 8}px`);
    }
    menuBtn.addEventListener("click", () => {
      const expanded = nav.getAttribute("aria-expanded") === "true";
      nav.setAttribute("aria-expanded", String(!expanded));
      menuBtn.setAttribute("aria-expanded", String(!expanded));
      updateAnchorOffset();
    });
    window.addEventListener("load", updateAnchorOffset);
    window.addEventListener("resize", updateAnchorOffset);

    // ===== Journal state (unchanged) =====
    const todayEl = document.getElementById("today");
    const dateEl = document.getElementById("date");
    const emailEl = document.getElementById("email");
    const g1El = document.getElementById("g1");
    const g2El = document.getElementById("g2");
    const g3El = document.getElementById("g3");
    const lookEl = document.getElementById("look");
    const sref = document.getElementById("scripture_ref");

    const saveBtn = document.getElementById("saveBtn");
    const saveNewBtn = document.getElementById("saveNewBtn");
    const clearBtn = document.getElementById("clearBtn");

    const qEl = document.getElementById("q");
    const qEmailEl = document.getElementById("qEmail");
    const qFromEl = document.getElementById("qFrom");
    const qToEl = document.getElementById("qTo");

    const historyEl = document.getElementById("history");
    const emptyHistoryEl = document.getElementById("emptyHistory");

    const STORAGE_KEY = "jayteesf-gratitude-history";

    // ===== BLB helpers (kept) =====
    function blbSearchUrl(criteria, translation = 'ESV') {
      const base = 'https://www.blueletterbible.org/search/preSearch.cfm';
      const params = new URLSearchParams({ Criteria: criteria || '', t: translation, sort: 'Relevance' });
      return `${base}?${params.toString()}`;
    }
    const BOOK_SLUGS = {
      "Genesis":"gen","Exodus":"exo","Leviticus":"lev","Numbers":"num","Deuteronomy":"deu",
      "Joshua":"jos","Judges":"jdg","Ruth":"rut","1 Samuel":"1sa","2 Samuel":"2sa","1 Kings":"1ki","2 Kings":"2ki",
      "1 Chronicles":"1ch","2 Chronicles":"2ch","Ezra":"ezr","Nehemiah":"neh","Esther":"est","Job":"job",
      "Psalm":"psa","Psalms":"psa","Proverbs":"pro","Ecclesiastes":"ecc","Song of Solomon":"son",
      "Isaiah":"isa","Jeremiah":"jer","Lamentations":"lam","Ezekiel":"eze","Daniel":"dan","Hosea":"hos",
      "Joel":"joe","Amos":"amo","Obadiah":"oba","Jonah":"jon","Micah":"mic","Nahum":"nam","Habakkuk":"hab",
      "Zephaniah":"zep","Haggai":"hag","Zechariah":"zec","Malachi":"mal",
      "Matthew":"mat","Mark":"mrk","Luke":"luk","John":"jhn","Acts":"act","Romans":"rom",
      "1 Corinthians":"1co","2 Corinthians":"2co","Galatians":"gal","Ephesians":"eph","Philippians":"phl","Colossians":"col",
      "1 Thessalonians":"1th","2 Thessalonians":"2th","1 Timothy":"1ti","2 Timothy":"2ti","Titus":"tit","Philemon":"phm",
      "Hebrews":"heb","James":"jas","1 Peter":"1pe","2 Peter":"2pe","1 John":"1jo","2 John":"2jo","3 John":"3jo",
      "Jude":"jud","Revelation":"rev"
    };
    function toBlbVerseUrl(ref, translation = "esv") {
      if (!ref) return null;
      const m = ref.match(/^\s*([1-3]?\s?[A-Za-z. ]+?)\s+(\d+):(\d+)\s*$/);
      if (!m) return null;
      const bookName = m[1].replace(/\.$/, "").replace(/\s+/g, " ").trim();
      const chap = m[2], verse = m[3];
      const slug = BOOK_SLUGS[bookName] || BOOK_SLUGS[(bookName||"").replace(/\.$/,"")];
      if (!slug) return null;
      return `https://www.blueletterbible.org/verse/${translation.toLowerCase()}/${slug}/${chap}/${verse}/`;
    }

    // ===== Data & renderer (unchanged) =====
    const TOPIC_VERSES = {
      gratitude: ['Psalm 107:1','1 Thessalonians 5:18','Colossians 3:15','Psalm 103:1-5','Philippians 4:6','James 1:17','Psalm 118:24','Ephesians 5:20','Psalm 136:1','Hebrews 13:15'],
      hope: ['Jeremiah 29:11','Romans 15:13','Lamentations 3:22-24','Psalm 42:5','Hebrews 6:19'],
      peace: ['John 14:27','Philippians 4:7','Isaiah 26:3','Colossians 3:15','Psalm 29:11']
    };
    function uid() { return `g_${Math.random().toString(36).slice(2)}_${Date.now().toString(36)}`; }
    function fmtDate(d) { return new Date(d).toLocaleDateString(undefined, { year:"numeric", month:"short", day:"numeric" }); }
    const now = new Date();
    todayEl.textContent = now.toLocaleDateString(undefined, { weekday:"long", month:"short", day:"numeric" });
    dateEl.valueAsDate = now;

    function loadHistory(){ try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"); } catch { return []; } }
    function saveHistory(rows){ localStorage.setItem(STORAGE_KEY, JSON.stringify(rows)); }
    function escapeHtml(str){ return (str || "").replace(/[&<>"]/g, c => ({"&":"&amp;","<":"&lt;","&gt;": "&gt;","\"":"&quot;"}[c])); }

    function createEntryFromForm() {
      return {
        id: uid(),
        email: emailEl.value.trim(),
        date: dateEl.value || new Date().toISOString().slice(0,10),
        g1: g1El.value.trim(),
        g2: g2El.value.trim(),
        g3: g3El.value.trim(),
        look: lookEl.value.trim(),
        scripture_ref: sref.value.trim(),
        scripture_url: (toBlbVerseUrl(sref.value || "") || undefined),
        createdAt: new Date().toISOString()
      };
    }
    function upsertEntry(entry){ const rows = loadHistory(); const i = rows.findIndex(r => r.id===entry.id); if(i>=0) rows[i]=entry; else rows.push(entry); saveHistory(rows); renderHistory(); }
    function deleteEntry(id){ saveHistory(loadHistory().filter(r=>r.id!==id)); renderHistory(); }

    function applyFilters(rows) {
      const q = (qEl.value||"").toLowerCase();
      const qe = (qEmailEl.value||"").toLowerCase();
      const from = qFromEl.value ? new Date(qFromEl.value) : null;
      const to = qToEl.value ? new Date(qToEl.value) : null;
      return rows.filter(r => {
        const hay = [r.g1,r.g2,r.g3,r.look,r.scripture_ref].join(" ¬∑ ").toLowerCase();
        if (q && !hay.includes(q)) return false;
        if (qe && !(r.email||"").toLowerCase().includes(qe)) return false;
        const d = new Date(r.date);
        if (from && d < from) return false;
        if (to) { const end = new Date(to); end.setHours(23,59,59,999); if (d > end) return false; }
        return true;
      });
    }
    function historyItemHtml(r) {
      const scriptureHtml = r.scripture_ref ? (() => {
        const direct = r.scripture_url || toBlbVerseUrl(r.scripture_ref);
        const fallback = blbSearchUrl(r.scripture_ref);
        const href = direct || fallback;
        return `<div class="inline-form-help">Scripture: <a href="${href}" target="_blank" rel="noopener">${escapeHtml(r.scripture_ref)}</a></div>`;
      })() : "";
      return `
        <h4>
          <span>${fmtDate(r.date)} ${r.email ? `<span class="pill">${escapeHtml(r.email)}</span>` : ""}</span>
          <span>
            <button class="icon-btn" data-edit="${r.id}" title="Edit">‚úé</button>
            <button class="icon-btn" data-del="${r.id}" title="Delete">üóë</button>
          </span>
        </h4>
        <ul class="list" style="margin:.5rem 0 .7rem">
          <li><strong>1)</strong> ${escapeHtml(r.g1)}</li>
          <li><strong>2)</strong> ${escapeHtml(r.g2)}</li>
          <li><strong>3)</strong> ${escapeHtml(r.g3)}</li>
          <li><strong>Looking forward:</strong> ${escapeHtml(r.look)}</li>
        </ul>
        ${scriptureHtml}
      `;
    }
    function renderHistory() {
      const all = loadHistory().sort((a,b) => new Date(b.date) - new Date(a.date) || new Date(b.createdAt||0) - new Date(a.createdAt||0));
      const rows = applyFilters(all);
      historyEl.innerHTML = "";
      if (!rows.length) { emptyHistoryEl.hidden = false; return; }
      emptyHistoryEl.hidden = true;
      for (const r of rows) {
        const div = document.createElement("div");
        div.className = "history-item";
        div.innerHTML = historyItemHtml(r);
        historyEl.appendChild(div);
      }
      historyEl.querySelectorAll('[data-edit]').forEach(btn => btn.addEventListener('click', () => loadIntoComposer(btn.getAttribute('data-edit'))));
      historyEl.querySelectorAll('[data-del]').forEach(btn => btn.addEventListener('click', () => {
        const id = btn.getAttribute('data-del');
        if (confirm('Delete this entry?')) deleteEntry(id);
      }));
    }
    function loadIntoComposer(id) {
      const r = loadHistory().find(x => x.id === id);
      if (!r) return;
      emailEl.value = r.email || '';
      dateEl.value = r.date || new Date().toISOString().slice(0,10);
      g1El.value = r.g1 || '';
      g2El.value = r.g2 || '';
      g3El.value = r.g3 || '';
      lookEl.value = r.look || '';
      sref.value = r.scripture_ref || '';
      saveBtn.dataset.editing = id;
      saveNewBtn.dataset.editing = id;
      updateOpenVerseLink();
    }
    function clearComposer() {
      g1El.value = g2El.value = g3El.value = lookEl.value = sref.value = '';
      delete saveBtn.dataset.editing;
      delete saveNewBtn.dataset.editing;
      updateOpenVerseLink();
    }

    saveBtn.addEventListener('click', () => {
      const editing = saveBtn.dataset.editing;
      if (editing) {
        const rows = loadHistory();
        const idx = rows.findIndex(r => r.id === editing);
        if (idx >= 0) {
          rows[idx] = { ...rows[idx], ...createEntryFromForm(), id: editing };
          saveHistory(rows);
        }
      } else {
        upsertEntry(createEntryFromForm());
      }
      renderHistory();
    });
    saveNewBtn.addEventListener('click', () => {
      const editing = saveNewBtn.dataset.editing;
      if (editing) {
        const rows = loadHistory();
        const idx = rows.findIndex(r => r.id === editing);
        if (idx >= 0) rows[idx] = { ...rows[idx], ...createEntryFromForm(), id: editing };
        saveHistory(rows);
      } else {
        upsertEntry(createEntryFromForm());
      }
      clearComposer();
      dateEl.valueAsDate = new Date();
      renderHistory();
    });
    clearBtn.addEventListener('click', clearComposer);

    document.getElementById('purgeBtn').addEventListener('click', () => {
      if (confirm('Delete ALL saved entries on YOUR own device? This cannot be undone.')) {
        localStorage.removeItem(STORAGE_KEY);
        renderHistory();
      }
    });

    document.getElementById('exportBtn').addEventListener('click', () => {
      const blob = new Blob([localStorage.getItem(STORAGE_KEY) || '[]'], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'gratitude-history.json'; a.click();
      URL.revokeObjectURL(url);
    });

    document.getElementById('importInput').addEventListener('change', async (e) => {
      const file = e.target.files[0]; if (!file) return;
      const text = await file.text();
      try {
        const incoming = JSON.parse(text);
        const map = new Map();
        for (const r of loadHistory()) map.set(r.id, r);
        for (const r of Array.isArray(incoming) ? incoming : []) map.set(r.id || uid(), { id: r.id || uid(), ...r });
        saveHistory(Array.from(map.values()));
        renderHistory();
      } catch(_) { alert('Invalid JSON file.'); }
      e.target.value = '';
    });

    document.getElementById('filterBtn').addEventListener('click', renderHistory);
    document.getElementById('resetBtn').addEventListener('click', () => {
      qEl.value = qEmailEl.value = qFromEl.value = qToEl.value = '';
      renderHistory();
    });

    // ===== Live topic suggestions + BLB form binding =====
    const topicEl = document.getElementById('topic');
    const suggestionsEl = document.getElementById('suggestions');
    const blbCriteria = document.getElementById('blbCriteria');
    const blbTranslation = document.getElementById('blbTranslation');
    function pickRandom(arr, n=5) {
      const copy = [...arr];
      for (let i = copy.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [copy[i], copy[j]] = [copy[j], copy[i]];
      }
      return copy.slice(0, Math.min(n, copy.length));
    }
    function renderSuggestions(topic='gratitude') {
      const key = (topic||'').toLowerCase().trim();
      const pool = TOPIC_VERSES[key] || [];
      const picks = pool.length ? pickRandom(pool, 5) : [];
      suggestionsEl.innerHTML = '';
      if (!picks.length) {
        const div = document.createElement('div');
        div.className = 'inline-form-help';
        const href = blbSearchUrl(topic || '');
        div.innerHTML = `No built-in list for that topic. Try <a href="${href}" target="_blank" rel="noopener">BLB topic search</a>.`;
        suggestionsEl.appendChild(div);
        return;
      }
      for (const ref of picks) {
        const row = document.createElement('div');
        row.className = 'suggest-item';
        const verseUrl = toBlbVerseUrl(ref) || blbSearchUrl(ref, blbTranslation.value || 'ESV');
        row.innerHTML = `<a href="${verseUrl}" target="_blank" rel="noopener">${ref}</a>
                         <button class="icon-btn" data-use="${ref}">Use</button>`;
        suggestionsEl.appendChild(row);
      }
      suggestionsEl.querySelectorAll('[data-use]').forEach(btn => btn.addEventListener('click', () => {
        sref.value = btn.getAttribute('data-use');
        updateOpenVerseLink();
      }));
    }
    function updateTopicBindings() {
      const val = topicEl.value || 'gratitude';
      blbCriteria.value = val;            // bind hidden BLB Criteria
      renderSuggestions(val);             // live-refresh suggestions
    }
    topicEl.addEventListener('input', updateTopicBindings);

    // This element was removed from the DOM; keep reference but guard in the updater:
    const openVerseLink = document.getElementById('openVerseLink');
    function updateOpenVerseLink() {
      if (!openVerseLink) return;               // <-- guard so no error when link is absent
      const url = toBlbVerseUrl(sref.value || '');
      openVerseLink.href = url || '#';
      openVerseLink.style.pointerEvents = url ? 'auto' : 'none';
    }
    sref.addEventListener('input', updateOpenVerseLink);

    // initial state
    updateTopicBindings();
    updateOpenVerseLink();   // safe even if the link element is not present
    renderHistory();

    // ===== CSV (unchanged) =====
    function toCsv(rows) {
      const headers = ['id','email','date','g1','g2','g3','look','scripture_ref','scripture_url','createdAt'];
      const escapeCsv = (v) => {
        const s = (v==null? '' : String(v));
        if (/[",\n]/.test(s)) return '"' + s.replace(/"/g,'""') + '"';
        return s;
      };
      const lines = [headers.join(',')];
      for (const r of rows) lines.push(headers.map(h => escapeCsv(r[h])).join(','));
      return lines.join('\r\n');
    }
    document.getElementById('exportCsvBtn').addEventListener('click', () => {
      const csv = toCsv(loadHistory());
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'gratitude-history.csv'; a.click();
      URL.revokeObjectURL(url);
    });

    // ===== Inline tests (kept; Relevance present) =====
    (function runTests(){
      try {
        const s1 = blbSearchUrl('gratitude');
        console.assert(s1.includes('preSearch.cfm') && s1.includes('Criteria=gratitude') && s1.includes('sort=Relevance') && s1.includes('t=ESV'), 'blbSearchUrl ok');
        const v1 = toBlbVerseUrl('James 1:17');
        console.assert(v1 && /\/verse\/esv\/jas\/1\/17\//.test(v1), 'verse URL ok');
        console.info('Inline tests passed.');
      } catch (e) { console.error('Inline tests failed:', e); }
    })();
  </script>
</body>
</html>
